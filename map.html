<!-- Load the Polymer.Element base class -->
<link rel="import" href="bower_components/polymer/polymer-element.html">
<script src="bower_components/leaflet/dist/leaflet.js"></script>

<dom-module id="scratch-map">
  <template>
    <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css"></link>
    <!-- Styles MUST be inside template -->
    <style>

      :host, #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }



    .animateFill {
      fill-opacity: 0;
      animation-timing-function: ease-in-out;
      animation-fill-mode: forwards;
      animation-iteration: 1;
      
      animation-name: fillIn;
      animation-duration: 3s;
      animation-delay: 0s;
    }

      @keyframes fillIn {
        from { fill-opacity: 0.35; }
        to { fill-opacity: 0.75; }
      }

    </style>

    <div id="map"></div>

  </template>

  <script>

    // Extend Polymer.Element base class
    class ScratchMap extends Polymer.Element {

      static get is() { return 'scratch-map' }

      static get config() {
        // properties, observers meta data
        return {
          map : null,
          countriesStyle: null,
          scratchedCountriesStyle: null,
          totalVisited: 0,
          totalCountries: 0,
          visitedCountriesList: [],
          countryCodes: [],
        };
      }

      connectedCallback() {
        super.connectedCallback();

      } 

      ready() {

        super.ready();

        const mapEl = this.$.map;
        this.map = L.map(mapEl, {attributionControl: false}).setView([0.0, 0.0], 3);
        L.control.attribution({position: "topright"} ).addTo(this.map)

        // Handle if the map is shared
        this.sharedCountryCodes = [];
        this.sharedLength = 0;

        if (window.location.search.indexOf('?countryCodes') > -1) {
          const codesUrl = window.location.href;
          const codesUrlObj = new URL(codesUrl);
          const codes = codesUrlObj.searchParams.get("countryCodes");
          this.sharedCountryCodes = JSON.parse(codes);
          this.sharedLength = this.sharedCountryCodes.length;
        };

        this.countryCodes = [];
        this.visitedCountriesList = [];

        // Styles for unscratched and scratched countries
        this.countriesStyle = { 
          stroke: true,
          color: "rgba(0,0,0,0.15)",
          weight: 2,
          fillOpacity: 0.45,
          fill: true,
          fillColor: "rgba(0,0,0,0.15)",
        }
        this.scratchedCountriesStyle = {
          fillColor: "#D4AF37",
          fillOpacity: 0.7,
          stroke: true,
          color: "rgba(0,0,0,0.15)",
        }
        
        this.addOSMBasemapLayer();
        this.addCountriesLayer();

        // Remind me why this is in a timeout?
        setTimeout( () => {
          this.map.invalidateSize();
        }, 10);
        
      }

      addOSMBasemapLayer() {
        const services = "https://server.arcgisonline.com/ArcGIS/rest/services";
        const url = services + "/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}";
        L.tileLayer(url, {
          attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
          maxZoom: 8,
          minZoom: 3,
          noWrap: true  
        }).addTo(this.map);
      }


      addCountriesLayer() {
        fetch("countries-simple.geojson").then((geojson) => {
          geojson.json().then((countries) => {

            L.geoJson(countries,    {
              style: this.styleFeature.bind(this),
              onEachFeature: this.onEachCountryFeature.bind(this)
            }).addTo(this.map);
         
            this.totalCountries = countries.features.length;

            countries.features.forEach( (feature) => {
             this.countryCodes.push(feature.properties.ADMIN);
            })

            this.emitVisitedChange();
            this.emitTotalChange();
            this.emitUrlChange();
    
            console.debug("Total Countries", this.totalCountries);

          });
        });
      }

      onEachCountryFeature(feature, layer) {

        if (this.sharedLength > 0) {
          
          const countryName = feature.properties.ADMIN
          const scratchedCountry = this.sharedCountryCodes.indexOf(countryName) > -1;

        if (scratchedCountry) {
            layer.setStyle(this.scratchedCountriesStyle);
        }

        } else {
            
          // If it is a shared link, it is an interactive map
          // We register both click and touch support
          const handle = function(event){ 

            const mapSvg = layer._path;
            mapSvg.classList.add("animateFill")
            
            this.handleClick(event, feature, layer) 
          }.bind(this);

          layer.on('click', handle);
          layer.on('tap', handle);

        }

      }

      handleClick(event, feature, layer) {
        const countryFeature = event.target;
        const countryCode = feature.properties.ADMIN; 
        const visited = this.getVisited(countryCode);
        
        if (visited === false || visited === null) {
          countryFeature.setStyle(this.scratchedCountriesStyle);
          this.setVisited(countryCode, "true");
          
        } else {
          countryFeature.setStyle(this.countriesStyle);
          this.setVisited(countryCode, "false");
        }

        this.emitVisitedChange();
        this.emitUrlChange();
      }

      styleFeature(feature, layer) {
        const visited = this.getVisited(feature.properties.ADMIN);
        if (visited === false || visited === null) {
            return this.countriesStyle; 
        } else {
          return this.scratchedCountriesStyle;
        }
      }

      getVisitedCount() {
        this.visitedCountries = 0;

        if (this.sharedLength) {
          this.visitedCountries = this.sharedLength;
        } else {
          this.countryCodes.forEach( (code) => {
            if (this.getVisited(code)) {
              this.visitedCountries += 1;
            } 
          });
        }
    
        return this.visitedCountries
      }

      emitTotalChange() {
        document.dispatchEvent(new CustomEvent('totalCountries', {
          detail : { totalCountries: this.totalCountries } 
        }));
      }
  
      emitVisitedChange() {
        document.dispatchEvent(new CustomEvent('visitedCountries', {
            detail : { visitedCountries: this.getVisitedCount() } 
        }));
      }

      emitUrlChange() {
        document.dispatchEvent(new CustomEvent('visitedUrl', {
            detail : { url: this.getUrl() } 
        }));
      }

      getVisited(countryCode) {
        const visited = localStorage.getItem(countryCode);
        if (visited === "true") {
          return true
        } else {
          return false
        }
      }
      
      setVisited(countryCode, hasVisited) {
        localStorage.setItem(countryCode, hasVisited);
      }

      getVisitedList() {
        this.visitedCountriesList = [];
        this.countryCodes.forEach( (code) => {
          if (this.getVisited(code)) {
            this.visitedCountriesList.push(code);
          } 
        });
        return JSON.stringify(this.visitedCountriesList);
      }

      getUrl() {
        let url = window.location.href.split('?')[0];
        url += '?countryCodes=' + this.getVisitedList();
        console.debug("Getting URL: ", url)
        return url;
      }

    }

    // Register custom element definition using standard platform API
    customElements.define(ScratchMap.is, ScratchMap);

  </script>
</dom-module>
