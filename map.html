<!-- Load the Polymer.Element base class -->
<link rel="import" href="bower_components/polymer/polymer-element.html">

<dom-module id="scratch-map">
  <template>

    <!-- Styles MUST be inside template -->
    <style>

      :host, #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }

    </style>

    <div id="map"></div>

  </template>

  <script>

    // Extend Polymer.Element base class
    class ScratchMap extends Polymer.Element {

      static get is() { return 'scratch-map' }

      static get config() {
        // properties, observers meta data
        return {
          map : null,
          countriesStyle: null,
          scratchedCountriesStyle: null,
          totalVisited: 0,
          totalCountries: 0,
          countryCodes: [],
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.visitedCountries = 0;
        this.countryCodes = [];

        const mapEl = this.$.map;
        this.countriesStyle = { 
          stroke: true,
          color: "rgba(0,0,0,0.15)",
          weight: 2,
          fillOpacity: 0.45,
          fill: true,
          fillColor: "rgba(0,0,0,0.15)",
        }
        this.scratchedCountriesStyle = {
          fillColor: "gold",
          fillOpacity: 0.7,
          stroke: true,
          color: "rgba(0,0,0,0.15)",
        }
        this.map = L.map(mapEl, {attributionControl: false}).setView([0.0, 0.0], 3);
        L.control.attribution({position: "topright"} ).addTo(this.map)
        this.addOSMBasemapLayer();
        this.addCountriesLayer();
      } 

      addOSMBasemapLayer() {
       L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
          maxZoom: 8,
          minZoom: 3,
          noWrap: true  
        }).addTo(this.map)
      }

      onEachCountryFeature(feature, layer) {
      
       layer.on('click', (event) => {
          const countryFeature = event.target;
          const countryCode = feature.properties.ADMIN; 
          const visited = this.getVisited(countryCode);
          
          if (visited === false || visited === null) {
            countryFeature.setStyle(this.scratchedCountriesStyle);
            this.setVisited(countryCode, "true");
            
          } else {
            countryFeature.setStyle(this.countriesStyle);
            this.setVisited(countryCode, "false");
          }

          this.emitVisitedChange();

        });


      }

      styleFeature(feature, layer) {
        const visited = this.getVisited(feature.properties.ADMIN);
        if (visited === false || visited === null) {
            return this.countriesStyle; 
          } else {
            return this.scratchedCountriesStyle;
          }
      }

      getVisitedCount() {
        this.visitedCountries = 0;
        this.countryCodes.forEach( (code) => {
          if (this.getVisited(code)) {
            this.visitedCountries += 1;
          } 
        });
        return this.visitedCountries
      }

      addCountriesLayer() {
        fetch("countries-simple.geojson").then((geojson) => {
          geojson.json().then((countries) => {

            L.geoJson(countries,    {
              style: this.styleFeature.bind(this),
              onEachFeature: this.onEachCountryFeature.bind(this)
            }).addTo(this.map);
         
            this.totalCountries = countries.features.length;

            countries.features.forEach( (feature) => {
             this.countryCodes.push(feature.properties.ADMIN);
            })

            this.emitVisitedChange();
            this.emitTotalChange();
    
            console.debug("Total Countries", this.totalCountries);

          });
        });
      }

      emitTotalChange() {
        document.dispatchEvent(new CustomEvent('totalCountries', {
          detail : { totalCountries: this.totalCountries } 
        }));
      }
  
      emitVisitedChange() {
        document.dispatchEvent(new CustomEvent('visitedCountries', {
            detail : { visitedCountries: this.getVisitedCount() } 
        }));
      }

      getVisited(countryCode) {
        const visited = localStorage.getItem(countryCode);
        if (visited === "true") {
          return true
        } else {
          return false
        }
      }
      
      setVisited(countryCode, hasVisited) {
        localStorage.setItem(countryCode, hasVisited);
      }

    }

    // Register custom element definition using standard platform API
    customElements.define(ScratchMap.is, ScratchMap);

  </script>
</dom-module>
